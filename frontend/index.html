<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SCZN3 — POIB Anchor Test</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 18px; }
    h1 { font-size: 40px; margin: 0 0 12px; }
    .card { border: 2px solid #111; border-radius: 10px; padding: 14px; max-width: 760px; }
    label { display:block; font-weight:800; margin: 10px 0 6px; }
    input, select, textarea { width: 100%; font-size: 18px; padding: 10px 12px; border-radius: 8px; border: 1px solid #bbb; }
    textarea { min-height: 110px; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 14px; }
    .row { display:flex; gap: 10px; }
    .row > div { flex:1; }
    button { margin-top: 12px; width: 100%; padding: 14px; font-size: 22px; border-radius: 10px; border: 2px solid #1a5fb4; background:#fff; font-weight:900; }
    .muted { color:#555; margin-top: 8px; }
    .box { margin-top: 14px; border: 2px solid #1f7a3a; border-radius: 10px; padding: 12px; display:none; }
    pre { white-space: pre-wrap; word-break: break-word; background: #111; color: #eee; padding: 12px; border-radius: 10px; margin: 10px 0 0; }
  </style>
</head>
<body>
  <h1>POIB Anchor Test</h1>

  <div class="card">
    <label>Backend Endpoint</label>
    <input id="endpoint" value="https://sczn3-sec-backend-pipe-17.onrender.com/api/sec" />

    <div class="row">
      <div>
        <label>Target Size</label>
        <select id="targetSize">
          <option value="8.5x11">8.5x11</option>
        </select>
      </div>
      <div>
        <label>Distance (yards)</label>
        <input id="distanceYards" type="number" value="100" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Click Value (MOA)</label>
        <input id="clickValueMoa" type="number" step="0.01" value="0.25" />
      </div>
      <div>
        <label>Deadband (inches)</label>
        <input id="deadbandIn" type="number" step="0.01" value="0.10" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Bull X (inches)</label>
        <input id="bullX" type="number" step="0.01" value="4.25" />
      </div>
      <div>
        <label>Bull Y (inches)</label>
        <input id="bullY" type="number" step="0.01" value="5.50" />
      </div>
    </div>

    <label>Image (optional for now)</label>
    <input id="file" type="file" accept="image/*" />

    <label>Holes JSON (in inches)</label>
    <textarea id="holesJson"></textarea>
    <div class="muted">Tip: You can test without detection by using Demo Holes.</div>

    <button id="demoBtn">Load Demo Holes (UL)</button>
    <button id="sendBtn">Send</button>

    <div class="box" id="resultBox">
      <div id="clicksLine" style="font-size:22px; font-weight:900;"></div>
      <div class="muted" id="signedLine"></div>
      <label style="margin-top:12px;">
        <input type="checkbox" id="showJson" checked />
        Show raw JSON
      </label>
      <pre id="jsonOut"></pre>
    </div>
  </div>

<script>
  const endpointEl = document.getElementById("endpoint");
  const holesEl = document.getElementById("holesJson");
  const resultBox = document.getElementById("resultBox");
  const clicksLine = document.getElementById("clicksLine");
  const signedLine = document.getElementById("signedLine");
  const jsonOut = document.getElementById("jsonOut");
  const showJson = document.getElementById("showJson");

  function normalizeEndpoint(u) {
    u = String(u || "").trim();
    if (!u) return "";
    if (u.endsWith("/")) u = u.slice(0, -1);
    if (!u.endsWith("/api/sec")) u += "/api/sec";
    return u;
  }

  function fmt2(n) {
    const x = Number(n);
    return Number.isFinite(x) ? x.toFixed(2) : "0.00";
  }

  document.getElementById("demoBtn").addEventListener("click", () => {
    // Demo: impacts in upper-left of bull (so output should be RIGHT + DOWN)
    const demo = [
      { x: 3.90, y: 4.80 },
      { x: 3.95, y: 4.75 },
      { x: 4.05, y: 4.85 },
      { x: 3.88, y: 4.78 }
    ];
    holesEl.value = JSON.stringify(demo, null, 2);
  });

  showJson.addEventListener("change", () => {
    jsonOut.style.display = showJson.checked ? "block" : "none";
  });

  document.getElementById("sendBtn").addEventListener("click", async () => {
    const endpoint = normalizeEndpoint(endpointEl.value);
    endpointEl.value = endpoint;

    const targetSizeSpec = document.getElementById("targetSize").value;
    const distanceYards = document.getElementById("distanceYards").value;
    const clickValueMoa = document.getElementById("clickValueMoa").value;
    const deadbandIn = document.getElementById("deadbandIn").value;
    const bullX = document.getElementById("bullX").value;
    const bullY = document.getElementById("bullY").value;

    if (!endpoint) return alert("Endpoint required.");
    if (!holesEl.value.trim()) return alert("Paste Holes JSON (or press Demo Holes).");

    const fd = new FormData();
    const file = document.getElementById("file").files?.[0];
    if (file) fd.append("image", file);

    fd.append("targetSizeSpec", targetSizeSpec);
    fd.append("distanceYards", String(distanceYards));
    fd.append("clickValueMoa", String(clickValueMoa));
    fd.append("deadbandIn", String(deadbandIn));
    fd.append("bullX", String(bullX));
    fd.append("bullY", String(bullY));
    fd.append("holesJson", holesEl.value.trim());

    resultBox.style.display = "none";
    clicksLine.textContent = "Sending...";

    try {
      const res = await fetch(endpoint, { method: "POST", body: fd });
      const text = await res.text();

      let data;
      try { data = JSON.parse(text); } catch { data = { ok:false, raw:text }; }

      resultBox.style.display = "block";
      jsonOut.textContent = JSON.stringify(data, null, 2);

      if (!data.ok) {
        clicksLine.textContent = `CAN’T COMPUTE`;
        signedLine.textContent = data?.error?.code ? `Error: ${data.error.code}` : "Error";
        return;
      }

      const w = Number(data?.clicksSigned?.windage);
      const e = Number(data?.clicksSigned?.elevation);

      const windDir = w >= 0 ? "RIGHT" : "LEFT";
      const elevDir = e >= 0 ? "UP" : "DOWN";

      clicksLine.textContent = `Windage: ${windDir} ${fmt2(Math.abs(w))} clicks | Elevation: ${elevDir} ${fmt2(Math.abs(e))} clicks`;
      signedLine.textContent = `clicksSigned: w=${fmt2(w)}, e=${fmt2(e)}`;
    } catch (err) {
      resultBox.style.display = "block";
      clicksLine.textContent = "Network error";
      signedLine.textContent = String(err?.message || err);
      jsonOut.textContent = "";
    }
  });
</script>
</body>
</html>
