/* ============================================================
   frontend_new/api.js (FULL REPLACEMENT)
   - Forces calls to the Render backend (no relative URL confusion)
   - Uses POST /api/calc
   - Surfaces REAL backend error text (no more "unknown")
============================================================ */

(() => {
  // âœ… Your Render backend:
  const BACKEND_BASE = "https://sczn3-backend-new.onrender.com";

  async function postJson(path, payload) {
    const url = `${BACKEND_BASE}${path}`;

    let res;
    try {
      res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });
    } catch (e) {
      throw new Error(`Network error calling backend: ${String(e?.message || e)}`);
    }

    // Read text first so we can show useful errors even if JSON parse fails
    const text = await res.text();

    let data = null;
    try {
      data = text ? JSON.parse(text) : null;
    } catch (_e) {
      data = null;
    }

    if (!res.ok) {
      const msg =
        (data && (data.error || data.detail)) ||
        text ||
        `HTTP ${res.status} ${res.statusText}`;
      throw new Error(msg);
    }

    if (!data) throw new Error("Backend returned empty response.");
    return data;
  }

  window.SCZN3_API = {
    backendBase: BACKEND_BASE,
    calc: (payload) => postJson("/api/calc", payload),
  };
})();
