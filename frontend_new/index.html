// frontend_new/clean-sec.js
// Minimal UI: Upload + Distance + Generate SEC.
// Shows errors on-screen (no silent failures).

(() => {
  // ✅ Your LIVE backend (padlocked)
  const BACKEND_BASE = "https://sczn3-backend-new.onrender.com";

  const el = (id) => document.getElementById(id);

  const fileEl = el("file");
  const fileBtn = el("fileBtn");
  const fileName = el("fileName");
  const yardsEl = el("yards");
  const btn = el("btn");
  const status = el("status");

  const secOut = el("secOut");
  const windageText = el("windageText");
  const elevText = el("elevText");
  const thumb = el("thumb");
  const lockLine = el("lockLine");

  function setStatus(msg) {
    status.textContent = msg;
  }

  // ✅ True MOA only (kept simple since you deleted the MOA controls)
  function inchesPerMOAAtYards(yards) {
    const y = Number(yards) || 100;
    return (1.047 * y) / 100;
  }

  // ✅ Default click value (kept simple since you deleted the click control)
  // If you want a different default later, change this ONE value.
  const MOA_PER_CLICK_DEFAULT = 0.25;

  function clicksFromInches(inches, yards) {
    const ipm = inchesPerMOAAtYards(yards);
    const moa = inches / ipm;
    const clicks = moa / MOA_PER_CLICK_DEFAULT;
    return Math.round(clicks * 100) / 100;
  }

  async function postAnalyze(file) {
    const fd = new FormData();
    fd.append("image", file); // backend expects "image"

    const url = `${BACKEND_BASE}/api/analyze`;
    const r = await fetch(url, { method: "POST", body: fd });

    const text = await r.text();
    let data;
    try { data = JSON.parse(text); }
    catch { data = { ok: false, error: "Non-JSON response", raw: text }; }

    if (!r.ok || !data.ok) {
      const err = data?.error || data?.message || `HTTP ${r.status}`;
      throw new Error(`Analyze failed: ${err}\nURL: ${url}\nRAW: ${text.slice(0, 300)}`);
    }

    return data;
  }

  function showSEC(apiData, fileObj, yards) {
    const { correction_in, directions, lock_version, coord_system } = apiData;

    const dx = Number(correction_in?.dx) || 0;
    const dy = Number(correction_in?.dy) || 0;

    const windClicks = clicksFromInches(Math.abs(dx), yards);
    const elevClicks = clicksFromInches(Math.abs(dy), yards);

    windageText.textContent = `${windClicks.toFixed(2)} ${directions?.windage || ""}`.trim();
    elevText.textContent = `${elevClicks.toFixed(2)} ${directions?.elevation || ""}`.trim();

    if (fileObj) {
      const url = URL.createObjectURL(fileObj);
      thumb.src = url;
      thumb.style.display = "block";
    } else {
      thumb.style.display = "none";
    }

    lockLine.textContent = `lock_version: ${lock_version || "?"} • coord_system: ${coord_system || "?"}`;
    secOut.style.display = "block";
  }

  async function onGenerate() {
    try {
      const f = fileEl.files && fileEl.files[0];
      if (!f) {
        setStatus("Pick a photo first.");
        return;
      }

      btn.disabled = true;
      secOut.style.display = "none";
      setStatus("Uploading…");

      const yards = Number(yardsEl.value) || 100;

      setStatus("Analyzing…");
      const a = await postAnalyze(f);

      setStatus("Building SEC…");
      showSEC(a, f, yards);

      setStatus("Done.");
    } catch (e) {
      setStatus(String(e));
    } finally {
      btn.disabled = false;
    }
  }

  // Wire up custom file button
  fileBtn.addEventListener("click", () => fileEl.click());
  fileEl.addEventListener("change", () => {
    const f = fileEl.files && fileEl.files[0];
    fileName.textContent = f ? f.name : "No file selected";
  });

  // Proof JS is loaded
  setStatus("Ready. JS loaded ✅");

  btn.addEventListener("click", onGenerate);
})();
